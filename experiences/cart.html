<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Red River Cart - Interactive Exhibit</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: 'Lato', sans-serif;
            color: white;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0; left: 0;
            z-index: 1;
        }

        /* Back Button */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            border: 2px solid #d4af37;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        .back-button:hover {
            background: #d4af37;
            color: white;
            transform: translateX(-3px);
        }

        /* Cinematic Vignette */
        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.8) 100%);
            z-index: 2;
        }

        /* UI Panel */
        #ui-panel {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            background: rgba(20, 20, 25, 0.85);
            backdrop-filter: blur(20px);
            border-top: 2px solid #d4af37; /* Gold border */
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            z-index: 10;
            text-align: center;
            transition: opacity 0.5s ease;
        }

        h1 {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: #d4af37;
            margin: 0 0 10px 0;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        p {
            font-size: 1rem;
            line-height: 1.6;
            color: #ddd;
            margin-bottom: 25px;
            min-height: 60px; /* Prevent jumpiness */
        }

        /* Navigation Buttons */
        .nav-container {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        button {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 10px 30px;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
        }

        button:hover {
            background: #d4af37;
            color: #111;
            border-color: #d4af37;
        }

        button:disabled {
            opacity: 0.3;
            cursor: default;
            pointer-events: none;
        }

        /* Progress Dots */
        .progress {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .dot {
            width: 8px; height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transition: background 0.3s;
        }
        .dot.active { background: #d4af37; }

        /* Credit footer */
        .experience-credit {
            position: fixed;
            bottom: 15px;
            right: 20px;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.4);
            text-align: right;
            pointer-events: none;
            z-index: 100;
        }
        .experience-credit .designer {
            color: rgba(255, 215, 0, 0.6);
        }
    </style>
</head>
<body>

    <a href="../index.html" class="back-button">← Back to Prairie</a>

    <div id="overlay"></div>

    <div id="ui-panel">
        <div class="progress" id="progress-container">
            <!-- Dots generated by JS -->
        </div>
        <h1 id="title-text">The Red River Cart</h1>
        <p id="desc-text">The iconic vehicle of the Métis Nation. A masterpiece of wooden engineering designed for the harsh prairies.</p>

        <div class="nav-container">
            <button id="btn-prev" onclick="prevSlide()">Previous</button>
            <button id="btn-next" onclick="nextSlide()">Next</button>
        </div>
    </div>

    <div id="canvas-container"></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- CONTENT DATA ---
        const slides = [
            {
                title: "The Red River Cart",
                text: "The iconic vehicle of the Métis Nation. Constructed entirely of wood and rawhide, it was designed to carry huge loads across the prairie landscape.",
                camPos: { x: 8, y: 5, z: 12 },
                lookAt: { x: 0, y: 1, z: 0 }
            },
            {
                title: "No Iron Used",
                text: "The carts contained no iron. Iron would break in the cold or bend in the heat. Instead, they used hardwood joints wrapped in wet 'shaganappi' (rawhide) which shrank to bind them tighter than nails.",
                camPos: { x: 3, y: 0.5, z: 3 }, // Zoom in on axle/joint
                lookAt: { x: 2, y: -0.5, z: 0 }
            },
            {
                title: "The Dished Wheels",
                text: "The massive wheels (up to 6ft high) were 'dished' (saucer-shaped). This prevented them from tipping in ruts and allowed the cart to be floated across rivers by removing the wheels and strapping them under the box.",
                camPos: { x: -4, y: 2, z: 6 }, // Zoom on wheel
                lookAt: { x: -2, y: 0, z: 1 }
            },
            {
                title: "The Squeak",
                text: "Because grease would collect dust and grind down the wood, the axles were left ungreased. Friction created a high-pitched squeal that could be heard for miles.",
                camPos: { x: 0, y: -1, z: 4 }, // Low angle axle
                lookAt: { x: 0, y: -1.5, z: 0 }
            },
            {
                title: "Commerce & Travel",
                text: "Organized in 'brigades' of hundreds, these carts carried buffalo meat, pemmican, and trade goods, creating the trails that became Western Canada's first highways.",
                camPos: { x: 0, y: 10, z: 0 }, // Top down view
                lookAt: { x: 0, y: 0, z: 0 }
            }
        ];

        let currentSlide = 0;
        let targetCamPos = new THREE.Vector3().copy(slides[0].camPos);
        let targetLookAt = new THREE.Vector3().copy(slides[0].lookAt);
        let currentLookAt = new THREE.Vector3().copy(slides[0].lookAt);

        // --- SCENE GLOBALS ---
        let scene, camera, renderer, composer;
        let cartGroup, wheels = [];
        let wheatMesh;

        // --- INIT ---
        function init() {
            const container = document.getElementById('canvas-container');

            // 1. Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x221100); // Dark brown/black horizon
            scene.fog = new THREE.FogExp2(0x221100, 0.03);

            // 2. Camera
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.copy(slides[0].camPos);

            // 3. Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0;
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.SoftShadowMap;
            container.appendChild(renderer.domElement);

            // 4. Post Processing (Cinematic Bloom)
            const renderScene = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0.3;
            bloomPass.strength = 0.6;
            bloomPass.radius = 0.5;

            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            // 5. Lighting
            const ambient = new THREE.AmbientLight(0xffccaa, 0.3);
            scene.add(ambient);

            // Sunset light
            const sun = new THREE.DirectionalLight(0xffaa00, 3);
            sun.position.set(-10, 5, 10);
            sun.castShadow = true;
            sun.shadow.mapSize.width = 2048;
            sun.shadow.mapSize.height = 2048;
            scene.add(sun);

            // Rim light for the cart
            const rimLight = new THREE.SpotLight(0x4455ff, 5);
            rimLight.position.set(5, 5, -5);
            rimLight.lookAt(0,0,0);
            scene.add(rimLight);

            // --- BUILD WORLD ---
            createCart();
            createEnvironment();
            setupUI();

            // Event Listeners
            window.addEventListener('resize', onResize);

            // Loop
            animate();
        }

        // --- 3D ASSETS ---

        function createCart() {
            cartGroup = new THREE.Group();

            // Textures (Procedural Wood)
            const woodMat = new THREE.MeshStandardMaterial({ color: 0x8B5A2B, roughness: 0.9, name: 'wood' });
            const rawhideMat = new THREE.MeshStandardMaterial({ color: 0xD2B48C, roughness: 0.6, name: 'rawhide' });

            // 1. The Axle (The Squeaky Part)
            const axleGeo = new THREE.BoxGeometry(4.5, 0.2, 0.2);
            const axle = new THREE.Mesh(axleGeo, woodMat);
            axle.position.y = -0.5;
            cartGroup.add(axle);

            // 2. The Box (Main Body)
            const boxGroup = new THREE.Group();
            // Floor
            const floorGeo = new THREE.BoxGeometry(2.5, 0.1, 4);
            const floor = new THREE.Mesh(floorGeo, woodMat);
            boxGroup.add(floor);

            // Vertical Posts
            const postGeo = new THREE.BoxGeometry(0.1, 1.2, 0.1);
            for(let x of [-1.2, 1.2]) {
                for(let z of [-1.9, -0.6, 0.6, 1.9]) {
                    const post = new THREE.Mesh(postGeo, woodMat);
                    post.position.set(x, 0.6, z);
                    boxGroup.add(post);

                    // Add "Shaganappi" ties (small torus knots at joints)
                    const tieGeo = new THREE.TorusGeometry(0.08, 0.02, 4, 8);
                    const tie = new THREE.Mesh(tieGeo, rawhideMat);
                    tie.position.set(x, 0.1, z);
                    tie.rotation.x = Math.PI/2;
                    boxGroup.add(tie);
                }
            }

            // Top Rails
            const railGeo = new THREE.BoxGeometry(0.1, 0.1, 4);
            const railL = new THREE.Mesh(railGeo, woodMat); railL.position.set(-1.2, 1.2, 0);
            const railR = new THREE.Mesh(railGeo, woodMat); railR.position.set(1.2, 1.2, 0);
            boxGroup.add(railL, railR);

            // Front/Back Rails
            const crossGeo = new THREE.BoxGeometry(2.5, 0.1, 0.1);
            const railF = new THREE.Mesh(crossGeo, woodMat); railF.position.set(0, 1.2, 1.9);
            const railB = new THREE.Mesh(crossGeo, woodMat); railB.position.set(0, 1.2, -1.9);
            boxGroup.add(railF, railB);

            // Shafts (for the horse/ox)
            const shaftGeo = new THREE.BoxGeometry(0.15, 0.15, 6);
            const shaftL = new THREE.Mesh(shaftGeo, woodMat); shaftL.position.set(-0.8, -0.2, 2); shaftL.rotation.x = -0.1;
            const shaftR = new THREE.Mesh(shaftGeo, woodMat); shaftR.position.set(0.8, -0.2, 2); shaftR.rotation.x = -0.1;
            cartGroup.add(shaftL, shaftR);

            cartGroup.add(boxGroup);

            // 3. The Wheels (Dished)
            const createWheel = (xPos) => {
                const wGroup = new THREE.Group();

                // Hub - cylinder along X axis (pointing outward from cart)
                const hubGeo = new THREE.CylinderGeometry(0.25, 0.25, 0.6, 12);
                const hub = new THREE.Mesh(hubGeo, woodMat);
                hub.rotation.z = Math.PI / 2; // Rotate to point along X axis
                wGroup.add(hub);

                // Rim (Torus) - rotated to be vertical, facing outward
                const rim = new THREE.Mesh(new THREE.TorusGeometry(1.5, 0.12, 6, 16), woodMat);
                rim.rotation.y = Math.PI / 2; // Rotate to face outward (along X axis)
                // Dishing logic: Shift rim slightly relative to hub
                rim.position.x = xPos > 0 ? -0.2 : 0.2;
                wGroup.add(rim);

                // Spokes (12) - need to be in the plane of the wheel
                const spokeGeo = new THREE.BoxGeometry(0.08, 1.4, 0.08);
                for(let i=0; i<12; i++) {
                    const spoke = new THREE.Mesh(spokeGeo, woodMat);
                    // Rotate spoke around X axis to fan out in the YZ plane
                    spoke.rotation.x = (i/12) * Math.PI * 2;
                    // Slight angle for dishing effect
                    const dishAngle = xPos > 0 ? 0.1 : -0.1;
                    spoke.rotation.z = dishAngle;
                    // Offset for dishing
                    spoke.position.x = xPos > 0 ? -0.1 : 0.1;
                    wGroup.add(spoke);
                }

                wGroup.position.set(xPos, -0.5, 0);
                return wGroup;
            };

            const wLeft = createWheel(-2.4);
            const wRight = createWheel(2.4);

            wheels.push(wLeft, wRight);
            cartGroup.add(wLeft, wRight);

            // Shadows
            cartGroup.traverse(o => {
                if(o.isMesh) {
                    o.castShadow = true;
                    o.receiveShadow = true;
                }
            });

            scene.add(cartGroup);
        }

        function createEnvironment() {
            // Ground
            const groundMat = new THREE.MeshStandardMaterial({ color: 0x1a1510, roughness: 1 });
            const ground = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), groundMat);
            ground.rotation.x = -Math.PI/2;
            ground.position.y = -2.1; // Below wheels
            ground.receiveShadow = true;
            scene.add(ground);

            // Stylized Wheat Field (Instanced)
            const stalkGeo = new THREE.ConeGeometry(0.05, 1.5, 4);
            stalkGeo.translate(0, 0.75, 0);
            const stalkMat = new THREE.MeshBasicMaterial({ color: 0xaa8844 }); // Basic material cheap for glow

            const count = 3000;
            wheatMesh = new THREE.InstancedMesh(stalkGeo, stalkMat, count);

            const dummy = new THREE.Object3D();
            for(let i=0; i<count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const r = 5 + Math.random() * 30; // Leave center clear
                dummy.position.set(
                    Math.cos(angle) * r,
                    -2.1,
                    Math.sin(angle) * r
                );
                dummy.scale.setScalar(0.8 + Math.random()*0.5);
                dummy.rotation.y = Math.random() * Math.PI;
                dummy.rotation.z = (Math.random()-0.5) * 0.2;
                dummy.updateMatrix();
                wheatMesh.setMatrixAt(i, dummy.matrix);
            }
            scene.add(wheatMesh);
        }

        // --- UI LOGIC ---
        function setupUI() {
            const container = document.getElementById('progress-container');
            slides.forEach((_, i) => {
                const dot = document.createElement('div');
                dot.className = i === 0 ? 'dot active' : 'dot';
                container.appendChild(dot);
            });
            updateButtons();
        }

        window.nextSlide = () => {
            if (currentSlide < slides.length - 1) {
                currentSlide++;
                updateSlide();
            }
        };

        window.prevSlide = () => {
            if (currentSlide > 0) {
                currentSlide--;
                updateSlide();
            }
        };

        function updateSlide() {
            const data = slides[currentSlide];

            // Update Text
            document.getElementById('title-text').innerText = data.title;
            document.getElementById('desc-text').innerText = data.text;

            // Update Dots
            const dots = document.querySelectorAll('.dot');
            dots.forEach((d, i) => d.classList.toggle('active', i === currentSlide));

            // Set Camera Targets
            targetCamPos.set(data.camPos.x, data.camPos.y, data.camPos.z);
            targetLookAt.set(data.lookAt.x, data.lookAt.y, data.lookAt.z);

            updateButtons();
        }

        function updateButtons() {
            document.getElementById('btn-prev').disabled = currentSlide === 0;
            document.getElementById('btn-next').innerText = currentSlide === slides.length - 1 ? "Restart" : "Next";
            if (currentSlide === slides.length - 1) {
                document.getElementById('btn-next').onclick = () => {
                    currentSlide = 0;
                    updateSlide();
                };
            } else {
                document.getElementById('btn-next').onclick = window.nextSlide;
            }
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- ANIMATION ---

        function animate() {
            requestAnimationFrame(animate);

            // 1. Smooth Camera Movement (Lerp)
            camera.position.lerp(targetCamPos, 0.04);
            currentLookAt.lerp(targetLookAt, 0.04);
            camera.lookAt(currentLookAt);

            // 2. Slow Cart Rotation (To show off details)
            cartGroup.rotation.y = Math.sin(Date.now() * 0.0005) * 0.1; // Gentle sway

            // 3. Wheel Spin (Slowly, as if dragging through history)
            const time = Date.now() * 0.001;
            wheels.forEach(w => {
                w.rotation.x = time * 0.5;
            });

            // 4. Wheat Sway (Vertex shader simulation via manual matrix update is too heavy,
            // so we just rotate the whole mesh slightly for effect)
            wheatMesh.rotation.y = Math.sin(time * 0.2) * 0.02;

            composer.render();
        }

        init();
    </script>

    <div class="experience-credit">
        Designed by <span class="designer">Amarah Ishaque</span><br>
        EDU596 Métis Foundational Knowledge
    </div>
</body>
</html>
